#!/bin/bash
#
# This hook checks pre-commit that all newly added migrations have
# been up- and downgraded (at least) once.
# This should prevent adding migrations with broken "down"s.
#

cd db/progress/migrations
for newmig in `hg st -a *.py | cut -c3-`; do
  test -f ../store/migrations/$newmig.?one || \
        { echo "Migration $newmig added but never executed!" >&2; exit 2; }
  grep " down$" ../store/migrations/$newmig.?one &>/dev/null || \
        { echo "New migration $newmig was never downgraded!" >&2; exit 2; }
done
