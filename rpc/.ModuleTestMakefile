include ../../../etc/site.make
TTY ?= $(shell tty)

.PHONEY: test migrate

TESTS	= $(shell find . -name "*.cls" -printf "%P,")
SCRIPTS = $(wildcard tests.*)
RPCDEPS = deps=lib/xmlrpc/xmlrpc_access.i;lib/xmlrpc/timestamp.i;lib/log.i

test: migrate $(WORK_DIR)/tms/test/db/cache/all.pf
	@for script in $(SCRIPTS); do \
	    WORK_DIR=$(WORK_DIR) ./$$script || exit 2; \
	done
	@PROPATH=.:..:$(WORK_DIR)/tools:$(WORK_DIR)/tms \
	$(MPRO) -b -p gearbox/unit/run_tests.r \
		-clientlog /dev/null $(FORMAT_PARAMS) \
		-pf $(WORK_DIR)/tms/test/db/cache/all.pf \
	        -param "out=$(TTY),$(RPCDEPS),$(TESTS)"

migrate:
	$(MAKE) -C $(WORK_DIR)/tms/test/db create migrate DB_USER=""

$(WORK_DIR)/tms/test/db/cache/all.pf:
	$(MAKE) -C $(@D) $(@F)
